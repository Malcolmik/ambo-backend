generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  SUPER_ADMIN
  ADMIN
  WORKER
  CLIENT_VIEWER
  CLIENT_VIEWER_PENDING
}

enum ClientStatus {
  LEAD
  ACTIVE
  PAUSED
  CLOSED
}

// UPDATED: Simplified to just PRIORITY and CRITICAL
enum TaskPriority {
  PRIORITY    // For standalone services
  CRITICAL    // For package contracts
}

enum TaskStatus {
  NOT_STARTED
  IN_PROGRESS
  WAITING
  DONE
  REJECTED
}

enum ClientApprovalStatus {
  PENDING
  APPROVED
  REVISION_REQUESTED
}

enum PaymentStatus {
  INITIATED
  PENDING
  PAID
  FAILED
  CANCELLED
}

enum ContractStatus {
  ACTIVE
  AWAITING_PAYMENT
  AWAITING_QUESTIONNAIRE
  READY_FOR_ASSIGNMENT
  IN_PROGRESS
  ON_HOLD
  COMPLETE
  CANCELLED
}

enum PaymentProvider {
  PAYSTACK
}

enum JobStatus {
  DRAFT
  OPEN
  REVIEWING
  ASSIGNED
  IN_PROGRESS
  PENDING_REVIEW
  COMPLETED
  CANCELLED
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  WITHDRAWN
}

enum WorkerPaymentStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
}

// ============================================
// USER MODEL
// ============================================

model User {
  id               String    @id @default(cuid())
  name             String
  email            String    @unique
  phone            String?
  passwordHash     String
  role             Role
  active           Boolean   @default(true)
  resetToken       String?   @unique
  resetTokenExpiry DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  clients       Client[]       @relation("ClientLinkedUser")
  tasksAssigned Task[]         @relation("TaskAssignedTo")
  tasksCreated  Task[]         @relation("TaskCreatedBy")
  tasksPosted   Task[]         @relation("TaskPostedBy")
  tasksPaidBy   Task[]         @relation("TaskPaidBy")
  comments      TaskComment[]
  updates       TaskUpdate[]
  auditLogs     AuditLog[]
  payments      Payment[]
  notifications Notification[]
  files         File[]

  workerChats ChatChannel[] @relation("WorkerChats")
  messages    Message[]

  jobApplications       JobApplication[] @relation("WorkerApplications")
  reviewedApplications  JobApplication[] @relation("ApplicationReviewer")
}

// ============================================
// CLIENT MODEL
// ============================================

model Client {
  id            String       @id @default(cuid())
  companyName   String
  contactPerson String
  email         String
  phone         String
  whatsapp      String?
  logoUrl       String?
  status        ClientStatus @default(LEAD)
  notes         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  linkedUserId String?
  linkedUser   User?   @relation("ClientLinkedUser", fields: [linkedUserId], references: [id])

  // Relations
  tasks        Task[]
  contracts    Contract[]
  chatChannels ChatChannel[]
}

// ============================================
// CONTRACT MODEL
// ============================================

model Contract {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id])
  tasks    Task[]

  packageType String
  services    Json
  totalPrice  Float
  currency    String @default("USD")

  paymentStatus PaymentStatus  @default(PENDING)
  status        ContractStatus @default(AWAITING_PAYMENT)

  paymentRef     String? @unique
  chatChannelUrl String? @db.VarChar(191)

  // Relations
  payments      Payment[]
  questionnaire Questionnaire?
  review        Review?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// TASK MODEL (Updated with Job Broadcasting)
// ============================================

model Task {
  id                   String               @id @default(cuid())
  title                String
  description          String
  priority             TaskPriority         @default(PRIORITY)  // UPDATED: Default to PRIORITY
  status               TaskStatus           @default(NOT_STARTED)
  clientApprovalStatus ClientApprovalStatus @default(PENDING)
  dueDate              DateTime?
  requiresApproval     Boolean              @default(false)
  meta                 Json?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  contractId String?
  contract   Contract? @relation(fields: [contractId], references: [id])

  assignedToId String?
  assignedTo   User?   @relation("TaskAssignedTo", fields: [assignedToId], references: [id])

  createdById String
  createdBy   User   @relation("TaskCreatedBy", fields: [createdById], references: [id])

  // Job Broadcasting Fields
  jobStatus   JobStatus @default(DRAFT)
  isPublic    Boolean   @default(false)
  postedAt    DateTime?
  postedById  String?
  postedBy    User?     @relation("TaskPostedBy", fields: [postedById], references: [id])
  deadline    DateTime?

  // Worker Payment/Earnings Fields
  paymentAmount       Decimal?            @db.Decimal(10, 2)
  workerPaymentStatus WorkerPaymentStatus @default(PENDING)
  paidAt              DateTime?
  paidById            String?
  paidBy              User?               @relation("TaskPaidBy", fields: [paidById], references: [id])

  // Relations
  comments     TaskComment[]
  updates      TaskUpdate[]
  applications JobApplication[]

  @@index([jobStatus, isPublic])
  @@index([assignedToId, status])
  @@index([workerPaymentStatus])
  @@index([postedById])
}

// ============================================
// JOB APPLICATION MODEL
// ============================================

model JobApplication {
  id              String            @id @default(cuid())
  
  taskId          String
  task            Task              @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  workerId        String
  worker          User              @relation("WorkerApplications", fields: [workerId], references: [id])
  
  status          ApplicationStatus @default(PENDING)
  coverNote       String?           @db.Text
  
  appliedAt       DateTime          @default(now())
  reviewedAt      DateTime?
  reviewedById    String?
  reviewedBy      User?             @relation("ApplicationReviewer", fields: [reviewedById], references: [id])
  rejectionReason String?

  @@unique([taskId, workerId])
  @@index([taskId, status])
  @@index([workerId, status])
}

// ============================================
// PACKAGE MODEL (NEW)
// ============================================

model Package {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String              // e.g., "AMBO CLASSIC"
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2)
  currency    String   @default("USD")
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  
  // Custom features/items not from services (JSON array of strings)
  customFeatures Json?
  
  // Relations
  services    PackageService[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([isActive, sortOrder])
}

// ============================================
// SERVICE MODEL (NEW)
// ============================================

model Service {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2)
  currency    String   @default("USD")
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  
  // Relations
  packages    PackageService[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([isActive, sortOrder])
}

// ============================================
// PACKAGE-SERVICE JUNCTION (NEW)
// ============================================

model PackageService {
  id         String   @id @default(cuid())
  
  packageId  String
  package    Package  @relation(fields: [packageId], references: [id], onDelete: Cascade)
  
  serviceId  String
  service    Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime @default(now())
  
  @@unique([packageId, serviceId])
  @@index([packageId])
  @@index([serviceId])
}

// ============================================
// PLATFORM SETTINGS MODEL (UPDATED)
// ============================================

model PlatformSettings {
  id               String   @id @default("default")
  
  // Support Channels
  supportWhatsapp  String?
  supportEmail     String?
  supportInstagram String?
  supportPhone     String?
  
  // NEW: Legal Documents (Rich Text/HTML)
  termsAndConditions String? @db.Text
  privacyPolicy      String? @db.Text
  termsUpdatedAt     DateTime?
  privacyUpdatedAt   DateTime?
  
  updatedAt        DateTime @default(now()) @updatedAt
}

// ============================================
// EXISTING MODELS (Unchanged)
// ============================================

model Questionnaire {
  id         String   @id @default(cuid())
  contractId String   @unique
  contract   Contract @relation(fields: [contractId], references: [id])
  responses  Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Review {
  id         String   @id @default(cuid())
  contractId String   @unique
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  rating     Int
  feedback   String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model File {
  id                 String   @id @default(cuid())
  filename           String
  fileUrl            String
  fileType           String
  fileSize           Int
  cloudinaryPublicId String?
  uploadedById       String
  uploadedBy         User     @relation(fields: [uploadedById], references: [id])
  entityType         String
  entityId           String
  description        String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([entityType, entityId])
  @@index([uploadedById])
}

model Payment {
  id            String          @id @default(cuid())
  provider      PaymentProvider
  reference     String          @unique
  amount        Int
  currency      String          @default("NGN")
  status        PaymentStatus
  channel       String?
  paidAt        DateTime?
  customerEmail String?
  meta          Json?
  rawPayload    Json?

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  contractId String?
  contract   Contract? @relation(fields: [contractId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reference])
  @@index([status])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String
  title     String
  body      String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, read])
}

model TaskComment {
  id              String   @id @default(cuid())
  content         String
  isClientComment Boolean  @default(false)
  createdAt       DateTime @default(now())

  taskId String
  task   Task   @relation(fields: [taskId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])
}

model TaskUpdate {
  id            String      @id @default(cuid())
  oldStatus     TaskStatus?
  newStatus     TaskStatus?
  message       String?
  attachmentUrl String?
  timestamp     DateTime    @default(now())

  taskId String
  task   Task   @relation(fields: [taskId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])
}

model AuditLog {
  id         String   @id @default(cuid())
  actionType String
  entityType String
  entityId   String
  metaJson   Json?
  timestamp  DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
}

model ChatChannel {
  id       String  @id @default(cuid())
  clientId String
  client   Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  workerId String?
  worker   User?   @relation("WorkerChats", fields: [workerId], references: [id], onDelete: SetNull)

  lastMessageAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  messages Message[]

  @@unique([clientId, workerId])
  @@index([clientId])
  @@index([workerId])
  @@index([lastMessageAt])
}

model Message {
  id        String      @id @default(cuid())
  channelId String
  channel   ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  senderId String
  sender   User   @relation(fields: [senderId], references: [id], onDelete: Cascade)

  content String    @db.Text
  read    Boolean   @default(false)
  readAt  DateTime?

  attachments Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([channelId, createdAt])
  @@index([senderId])
}
